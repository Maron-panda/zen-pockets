<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Zen Pockets - Panda Bank</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* Reset & Base Styling (From your original form.css) */
    * { box-sizing: border-box; }
    html { height: 100%; overflow-x: hidden; }
    
    body {
      margin: 0; padding: 0;
      background: linear-gradient(to bottom, #fff0f5, #fdf6fb);
      font-family: 'Poppins', sans-serif;
      color: #444;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    /* Sakura Canvas */
    canvas.sakura {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none; z-index: 1000; opacity: 0.6;
    }

    /* Mascot Styling */
    .mascot { text-align: center; margin-top: 20px; margin-bottom: 10px; z-index: 10; position: relative; }
    .mascot img {
      width: 160px; height: auto; border-radius: 16px; object-fit: contain;
      animation: float 4s ease-in-out infinite;
    }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

    /* App Containers */
    #login-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: linear-gradient(to bottom, #fff0f5, #fdf6fb);
      display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
    }

    #app-container {
      width: 100%; max-width: 900px; padding: 20px; display: none; z-index: 10; position: relative;
    }

    .box-container {
      background: #fffefe; border-radius: 24px; padding: 30px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08); width: 100%;
    }
    .login-box { max-width: 400px; text-align: center; }

    /* Typography */
    h1, h2 { color: #ec6f9c; font-weight: 600; margin-bottom: 0.5em; text-align: center; }
    
    /* Forms & Inputs */
    label { display: block; margin-bottom: 6px; font-weight: 500; color: #7c4c66; font-size: 0.95rem; }
    input, select {
      width: 100%; padding: 10px 14px; margin-bottom: 20px;
      border: 2px solid #f1d7e0; border-radius: 12px; background: #fffefe;
      font-size: 0.95rem; font-family: 'Poppins', sans-serif; transition: 0.2s;
    }
    input:focus, select:focus { border-color: #f7a3c1; outline: none; box-shadow: 0 0 0 3px #fce4ed; }

    /* Select Dropdown Specifics */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f7a3c1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat; background-position: right 14px center; background-size: 16px; cursor: pointer;
    }

    /* Buttons */
    button {
      background: linear-gradient(to right, #fca4c1, #e48ccf); color: white;
      padding: 12px 20px; border: none; border-radius: 20px; font-size: 1rem;
      font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); transition: background 0.3s;
      font-family: 'Poppins', sans-serif; width: 100%;
    }
    button:hover { background: linear-gradient(to right, #f687b3, #d86dd1); }
    button:disabled { background: #d1d5db; cursor: not-allowed; box-shadow: none; }
    
    .btn-secondary {
      background: #fffefe; color: #e48ccf; border: 2px solid #e48ccf;
    }
    .btn-secondary:hover { background: #fdf6fb; color: #d86dd1; border-color: #d86dd1; }

    /* Sentence Form Styling */
    .sentence-input {
      display: flex; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;
      color: #7c4c66; font-weight: 500; font-size: 0.95rem; line-height: 2;
    }
    .sentence-input input {
      width: 90px; margin-bottom: 0; padding: 6px 10px; text-align: center;
    }

    /* Toggle Switch */
    .toggle-container { display: flex; background: #fdf6fb; border-radius: 20px; margin-bottom: 20px; border: 2px solid #f1d7e0; overflow: hidden; }
    .toggle-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: 600; color: #aa5e88; transition: 0.3s; }
    .toggle-btn.active { background: linear-gradient(to right, #fca4c1, #e48ccf); color: white; border-radius: 18px; }

    /* Dashboard Layout */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; width: 100%;}
    .header h1 { margin: 0; font-size: 1.8rem; }
    
    .totals-board { text-align: center; margin-bottom: 20px; }
    .totals-board h2 { font-size: 2.2rem; margin: 5px 0; }

    .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }

    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .tab-btn { background: #fffefe; color: #aa5e88; border: 2px solid #f1d7e0; padding: 8px 16px; border-radius: 20px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: 0.2s;}
    .tab-btn.active { background: #fce4ed; color: #b65784; border-color: #f7a3c1; }

    /* Cards (Redesigned to match overview.html) */
    .receipts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .card {
      background: #fffefe; border-radius: 20px; padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06); transition: transform 0.2s;
      display: flex; flex-direction: column; position: relative;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1); }
    
    .card-title { font-size: 1.2rem; font-weight: 600; color: #ec6f9c; margin: 0 0 10px 0; padding-right: 80px;}
    .card-date { font-size: 0.85rem; color: #999; margin-bottom: 15px; }
    
    /* Badges for cards */
    .status-pill { position: absolute; top: 20px; right: 20px; font-size: 0.75rem; font-weight: 600; padding: 4px 10px; border-radius: 12px; }
    .status-Pending { background: #fff0d4; color: #d9822b; }
    .status-Active { background: #fce4ed; color: #b65784; }
    .status-Paid { background: #e6f7ec; color: #2e8b57; }
    .status-Overdue { background: #fee2e2; color: #dc2626; animation: pulseRed 2s infinite;}
    
    @keyframes pulseRed {
      0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
      70% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }

    .card-amounts { display: flex; justify-content: space-between; align-items: baseline; border-top: 2px dashed #f1d7e0; padding-top: 15px; margin-top: auto;}
    .amt-main { font-size: 1.4rem; font-weight: 600; color: #7c4c66; }

    /* Modals */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(124, 76, 102, 0.6); z-index: 2000; justify-content: center; align-items: center; padding: 20px;
    }
    .modal-content { background: #fffefe; padding: 30px; border-radius: 24px; width: 100%; max-width: 450px; position: relative; max-height: 90vh; overflow-y: auto;}
    .close-btn { position: absolute; top: 20px; right: 20px; background: none; color: #aa5e88; font-size: 1.5rem; border: none; padding: 0; cursor: pointer; width: auto; box-shadow: none;}
    
    #loader { display: none; position: fixed; top: 20px; right: 20px; background: #fceef4; color: #b65784; padding: 10px 20px; border-radius: 20px; border: 2px dashed #f7a3c1; z-index: 9999; font-weight: 600; box-shadow: 0 4px 10px rgba(252, 174, 212, 0.2); }
  </style>
</head>
<body>

  <canvas id="sakura-canvas" class="sakura"></canvas>
  <div id="loader">üêº Loading...</div>

  <div id="login-overlay">
    <div class="mascot">
      <img src="momorin-placeholder.png" alt="Momorin the Mascot"> 
    </div>
    <div class="box-container login-box">
      <h2>üêº Welcome</h2>
      <p style="color: #aa5e88; font-size: 0.9rem; margin-bottom: 20px;">Enter the secret word to access the bank.</p>
      <input type="password" id="login-pwd" placeholder="Password">
      <button onclick="attemptLogin()" id="btn-login">Enter Bank</button>
      <p id="login-error" style="color: red; margin-top: 15px; font-size: 0.85rem; display: none;"></p>
    </div>
  </div>

  <div id="app-container">
    <div class="header">
      <h1>üêº Panda Bank</h1>
      <button class="btn-secondary" style="width: auto; padding: 8px 16px; font-size: 0.85rem;" onclick="location.reload()">Log Out</button>
    </div>

    <div class="box-container totals-board">
      <p style="font-weight: 500; color: #aa5e88; margin: 0;">Outstanding Balance</p>
      <h2 id="total-amount">0 kr</h2>
    </div>

    <div class="action-buttons">
      <button id="btn-new" onclick="openModal('loanModal')">Request Money</button>
      <button class="btn-secondary" onclick="openPaymentModal()">üí∏ Pay Back (General)</button>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="tab-active" onclick="setTab('Active')">Active Debts</button>
      <button class="tab-btn" id="tab-requests" onclick="setTab('Requests')">Requests</button>
      <button class="tab-btn" id="tab-paid" onclick="setTab('Paid')">Paid Stubs</button>
      <button class="tab-btn" id="tab-all" onclick="setTab('All')">Show All</button>
    </div>

    <div class="receipts-grid" id="receipts-container"></div>
  </div>

  <div id="loanModal" class="modal-overlay">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('loanModal')">&times;</button>
      <h2 id="loan-modal-title">New Entry</h2>
      
      <form id="loanForm" onsubmit="submitLoan(event)">
        
        <div id="toggle-wrapper" style="display: none;">
          <div class="toggle-container">
            <div class="toggle-btn active" id="tg-receipt" onclick="switchToggle('Receipt')">Receipt</div>
            <div class="toggle-btn" id="tg-request" onclick="switchToggle('Request')">Request</div>
          </div>
        </div>

        <label>What for?</label>
        <input type="text" id="l-title" placeholder="e.g. School loan" required>
        
        <div class="sentence-input" id="amt-sentence">
          I need at least 
          <input type="number" id="l-amount-min" required> 
          kr, but if possible 
          <input type="number" id="l-amount-ideal"> 
          kr.
        </div>

        <div id="amt-exact" style="display: none;">
          <label>Exact Amount (kr)</label>
          <input type="number" id="l-amount-exact">
        </div>
        
        <label>Due Date? (Optional)</label>
        <input type="date" id="l-duedate">
        
        <label>Source</label>
        <select id="l-source" required>
          <option value="Vipps">Vipps</option>
          <option value="Kontant">Kontant</option>
          <option value="Nordea">Nordea</option>
          <option value="DNB">DNB</option>
        </select>
        
        <button type="submit" id="btn-submit-loan" style="margin-top: 10px;">Submit</button>
      </form>
    </div>
  </div>

  <div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
      <h2 id="pay-title">üí∏ Pay Back</h2>
      
      <p id="pay-desc" style="font-size: 0.9rem; color: #aa5e88; margin-bottom: 20px; text-align: center;">
        Money paid will cover the oldest debts first.
      </p>

      <form id="paymentForm" onsubmit="submitPayment(event)">
        <input type="hidden" id="p-specific-id">
        
        <label>Amount Paid (kr)</label>
        <input type="number" id="p-amount" required>
        
        <label>Source</label>
        <select id="p-source" required>
          <option value="Vipps">Vipps</option>
          <option value="Kontant">Kontant</option>
          <option value="Nordea">Nordea</option>
          <option value="DNB">DNB</option>
        </select>

        <button type="submit" id="btn-submit-pay" style="margin-top: 10px;">Register Payment</button>
      </form>
    </div>
  </div>

  <div id="approveModal" class="modal-overlay">
    <div class="modal-content" style="text-align: center;">
      <button class="close-btn" onclick="closeModal('approveModal')">&times;</button>
      <h2>üå∏ Approve Request</h2>
      <p id="app-desc" style="margin: 15px 0; color: #7c4c66;"></p>
      
      <label style="text-align: left;">Final Amount to Send (kr):</label>
      <input type="number" id="app-final-amount" required>
      
      <p style="font-size: 0.8rem; color: #aa5e88; margin-bottom: 20px;">
        (Approving this will send a calendar invite!)
      </p>

      <input type="hidden" id="app-id">
      
      <div style="display: flex; gap: 10px;">
        <button class="btn-secondary" style="flex: 1;" onclick="processApproval(false)">Reject</button>
        <button style="flex: 1;" onclick="processApproval(true)">Approve ‚úÖ</button>
      </div>
    </div>
  </div>

  <script src="sakuraform.js"></script>
  <script>
    // ‚ö†Ô∏è REPLACE THIS URL WITH YOUR NEW APPS SCRIPT URL ‚ö†Ô∏è
    const scriptURL = 'https://script.google.com/macros/s/AKfycbz_HjbiEnpxGhJ6KMq1zZOzXATtcrWDR3an9zM069rKVVm2gtAboIgH7VW6Ac7Xpp8u/exec';
    
    let currentRole = ''; 
    let allTransactions = [];
    let currentFilter = 'Active'; 
    let currentEntryType = 'Request'; 

    async function apiCall(payload) {
      document.getElementById('loader').style.display = 'block';
      try {
        const response = await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });
        const data = await response.json();
        document.getElementById('loader').style.display = 'none';
        return data;
      } catch (error) {
        document.getElementById('loader').style.display = 'none';
        return { success: false, message: "Network Error: Is the Google Script URL correct?" };
      }
    }

    async function attemptLogin() {
      const pwd = document.getElementById('login-pwd').value;
      if (!pwd) return;

      const btn = document.getElementById('btn-login');
      const originalText = btn.textContent;
      btn.textContent = 'üå∏ Checking...';
      btn.disabled = true;
      document.getElementById('login-error').style.display = 'none';

      const res = await apiCall({ action: 'login', password: pwd });
      
      btn.textContent = originalText;
      btn.disabled = false;

      if (res.success) {
        currentRole = res.role;
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        
        if (currentRole === 'panda') {
          document.getElementById('btn-new').textContent = 'Log New Entry';
          document.getElementById('toggle-wrapper').style.display = 'block';
          switchToggle('Receipt'); 
        } else {
          switchToggle('Request'); 
        }
        fetchDashboardData();
      } else {
        document.getElementById('login-error').textContent = res.message || "Incorrect password!";
        document.getElementById('login-error').style.display = 'block';
      }
    }

    function switchToggle(type) {
      currentEntryType = type;
      if (type === 'Receipt') {
        document.getElementById('tg-receipt').classList.add('active');
        document.getElementById('tg-request').classList.remove('active');
        document.getElementById('amt-sentence').style.display = 'none';
        document.getElementById('amt-exact').style.display = 'block';
        document.getElementById('l-amount-exact').required = true;
        document.getElementById('l-amount-min').required = false;
      } else {
        document.getElementById('tg-request').classList.add('active');
        document.getElementById('tg-receipt').classList.remove('active');
        document.getElementById('amt-sentence').style.display = 'flex';
        document.getElementById('amt-exact').style.display = 'none';
        document.getElementById('l-amount-exact').required = false;
        document.getElementById('l-amount-min').required = true;
      }
    }

    async function fetchDashboardData() {
      const res = await apiCall({ action: 'get_data' });
      if (res.success) {
        allTransactions = res.data;
        updateTotals();
        renderReceipts();
      }
    }

    function updateTotals() {
      let total = 0;
      allTransactions.forEach(tx => {
        if (tx['Status'] === 'Active' || tx['Status'] === 'Overdue') {
          total += parseFloat(tx['Remaining Amount']) || 0;
        }
      });
      document.getElementById('total-amount').textContent = total.toLocaleString() + ' kr';
    }

    function setTab(tabName) {
      currentFilter = tabName;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      
      if(tabName === 'Active') document.getElementById('tab-active').classList.add('active');
      if(tabName === 'Requests') document.getElementById('tab-requests').classList.add('active');
      if(tabName === 'Paid') document.getElementById('tab-paid').classList.add('active');
      if(tabName === 'All') document.getElementById('tab-all').classList.add('active');
      
      renderReceipts();
    }

    function formatDate(isoString) {
      if (!isoString) return '';
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return '';
      return ('0' + d.getDate()).slice(-2) + '.' + ('0' + (d.getMonth() + 1)).slice(-2) + '.' + d.getFullYear();
    }

    function renderReceipts() {
      const container = document.getElementById('receipts-container');
      container.innerHTML = '';
      
      // Hide pure repayment logs from cards
      let filtered = allTransactions.filter(t => t['Entry Type'] !== 'Repayment'); 
      
      if (currentFilter === 'Active') {
        filtered = filtered.filter(t => t['Status'] === 'Active' || t['Status'] === 'Overdue');
      } else if (currentFilter === 'Requests') {
        filtered = filtered.filter(t => t['Status'] === 'Pending');
      } else if (currentFilter === 'Paid') {
        filtered = filtered.filter(t => t['Status'] === 'Paid');
      }

      if (filtered.length === 0) {
        container.innerHTML = `<p style="text-align:center; color:#aa5e88; width: 100%;">No items here! üå∏</p>`;
        return;
      }

      filtered.forEach(tx => {
        const card = document.createElement('div');
        card.className = `card`;
        
        let statusClass = `status-${tx['Status']}`;
        const originalAmt = parseFloat(tx['Original Amount']);
        const remainingAmt = parseFloat(tx['Remaining Amount']);
        const dateStr = formatDate(tx['Date']);
        const dueStr = tx['Due Date'] ? formatDate(tx['Due Date']) : '';
        
        let dueHTML = dueStr ? `<p style="margin: 0; color: #dc2626;"><strong>Due:</strong> ${dueStr}</p>` : '';
        
        let actionHTML = '';
        if (tx['Status'] === 'Pending' && currentRole === 'panda') {
          let displayAmt = tx['Original Amount'];
          actionHTML = `<button style="margin-top:15px;" onclick="openApproveModal('${tx['ID']}', '${tx['Title / Purpose']}', '${displayAmt}')">Review Request</button>`;
        } else if ((tx['Status'] === 'Active' || tx['Status'] === 'Overdue') && currentRole === 'shark') {
          actionHTML = `<button class="btn-secondary" style="margin-top:15px;" onclick="openPaymentModal('${tx['ID']}', ${remainingAmt})">üí∏ Pay This Specific Stub</button>`;
        }

        card.innerHTML = `
          <div class="card-title">${tx['Title / Purpose']}</div>
          <div class="status-pill ${statusClass}">${tx['Status']}</div>
          <div class="card-date">${dateStr}</div>
          ${dueHTML}
          <div class="card-amounts">
            <div><span style="font-size:0.85rem; color:#999;">Original: ${originalAmt} kr</span></div>
            <div class="amt-main">${tx['Status'] === 'Paid' ? 'Paid' : remainingAmt + ' kr'}</div>
          </div>
          ${actionHTML}
        `;
        container.appendChild(card);
      });
    }

    async function submitLoan(e) {
      e.preventDefault();
      document.getElementById('btn-submit-loan').disabled = true;
      let finalAmount = 0;
      
      if (currentEntryType === 'Request') {
        const min = document.getElementById('l-amount-min').value;
        const ideal = document.getElementById('l-amount-ideal').value;
        finalAmount = ideal ? `${min}-${ideal}` : min; 
      } else {
        finalAmount = document.getElementById('l-amount-exact').value;
      }

      const finalRole = (currentRole === 'panda' && currentEntryType === 'Request') ? 'shark' : currentRole;

      const res = await apiCall({
        action: 'submit_request', role: finalRole,
        title: document.getElementById('l-title').value,
        amount: finalAmount, dueDate: document.getElementById('l-duedate').value,
        source: document.getElementById('l-source').value
      });

      if(res.success) {
        closeModal('loanModal');
        document.getElementById('loanForm').reset();
        fetchDashboardData();
      }
      document.getElementById('btn-submit-loan').disabled = false;
    }

    function openPaymentModal(specificId = null, amountOwed = null) {
      document.getElementById('p-specific-id').value = specificId || '';
      if (specificId) {
        document.getElementById('pay-title').textContent = "üí∏ Pay Specific Stub";
        document.getElementById('pay-desc').textContent = "This payment will ONLY apply to this stub.";
        document.getElementById('p-amount').value = amountOwed;
      } else {
        document.getElementById('pay-title').textContent = "üí∏ Pay Back (General)";
        document.getElementById('pay-desc').textContent = "Money paid will cover the oldest debts first via waterfall logic.";
        document.getElementById('p-amount').value = '';
      }
      openModal('paymentModal');
    }

    async function submitPayment(e) {
      e.preventDefault();
      document.getElementById('btn-submit-pay').disabled = true;
      const res = await apiCall({
        action: 'log_payment',
        amount: document.getElementById('p-amount').value,
        source: document.getElementById('p-source').value,
        specificId: document.getElementById('p-specific-id').value
      });

      if(res.success) {
        closeModal('paymentModal');
        document.getElementById('paymentForm').reset();
        fetchDashboardData();
      }
      document.getElementById('btn-submit-pay').disabled = false;
    }

    function openApproveModal(id, title, reqAmountStr) {
      document.getElementById('app-id').value = id;
      document.getElementById('app-desc').textContent = `The Shark requested: ${reqAmountStr} kr for "${title}".`;
      let suggestedAmt = reqAmountStr.toString().split('-')[0];
      document.getElementById('app-final-amount').value = suggestedAmt;
      openModal('approveModal');
    }

    async function processApproval(isApproved) {
      const id = document.getElementById('app-id').value;
      const finalAmt = document.getElementById('app-final-amount').value;
      
      let res;
      if (isApproved) {
        if (!finalAmt) return alert("Please enter the final amount.");
        res = await apiCall({ action: 'approve_loan', id: id, finalAmount: finalAmt });
      } else {
        res = await apiCall({ action: 'reject_loan', id: id });
      }

      if(res.success) {
        closeModal('approveModal');
        fetchDashboardData();
      }
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  </script>
</body>
</html>
