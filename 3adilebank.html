<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Panda Bank üêºüå∏</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --pink-main: #f472b6;
      --pink-light: #fdf2f8;
      --pink-hover: #db2777;
      --text-dark: #4b5563;
      --text-soft: #9ca3af;
      --white: #ffffff;
      --active-tab: #f472b6;
      --inactive-tab: #fbcfe8;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Quicksand', sans-serif;
      background-color: var(--pink-light);
      background-image: radial-gradient(#fbcfe8 2px, transparent 2px);
      background-size: 30px 30px;
      color: var(--text-dark);
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      position: relative; overflow-x: hidden;
    }

    /* Floating Panda & Petals */
    .floating-panda {
      position: absolute; top: 10%; right: 5%; font-size: 3rem;
      animation: float 6s ease-in-out infinite; z-index: -1; opacity: 0.6;
    }
    .petal {
      position: absolute; font-size: 1.5rem; color: #f9a8d4; opacity: 0.5;
      animation: fall linear infinite; z-index: -1;
    }
    @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } }
    @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }

    #app-container { width: 100%; max-width: 800px; padding: 20px; display: none; }
    #login-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: var(--pink-light); display: flex; justify-content: center; align-items: center; z-index: 9999;
    }

    .box { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(244, 114, 182, 0.2); }
    .login-box { text-align: center; width: 90%; max-width: 400px; }

    /* Forms & Inputs */
    input, select {
      width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #fbcfe8;
      border-radius: 12px; font-family: 'Quicksand'; font-size: 1rem; color: var(--text-dark);
    }
    input:focus, select:focus { outline: none; border-color: var(--pink-main); }
    label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--pink-main); }

    /* Sentence Input for Amount */
    .sentence-input {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;
      background: #fdf2f8; padding: 15px; border-radius: 12px; border: 1px dashed var(--pink-main);
    }
    .sentence-input input { width: 80px; margin-bottom: 0; padding: 8px; text-align: center; }

    /* Buttons */
    button {
      background: var(--pink-main); color: white; border: none; padding: 12px 20px;
      border-radius: 20px; font-weight: 700; cursor: pointer; transition: 0.2s; font-family: 'Quicksand';
    }
    button:hover { background: var(--pink-hover); transform: translateY(-2px); }
    .btn-secondary { background: var(--inactive-tab); color: var(--text-dark); }
    .btn-secondary:hover { background: #f9a8d4; }
    .btn-reject { background: #ef4444; } .btn-reject:hover { background: #dc2626; }
    
    /* Toggle Switch */
    .toggle-container { display: flex; background: var(--inactive-tab); border-radius: 20px; margin-bottom: 15px; overflow: hidden;}
    .toggle-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: 600; transition: 0.3s; color: var(--text-soft);}
    .toggle-btn.active { background: var(--pink-main); color: white; border-radius: 20px;}

    /* Dashboard */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header h1 { color: var(--pink-main); }
    .totals-board { text-align: center; margin-bottom: 25px; }
    .totals-board h2 { font-size: 2.5rem; color: var(--pink-main); }

    .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }

    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--inactive-tab); padding-bottom: 10px;}
    .tab-btn { background: none; color: var(--text-soft); padding: 8px 15px; border-radius: 20px; font-weight: 600; }
    .tab-btn.active { background: var(--pink-main); color: white; }

    /* Cards */
    .receipts-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    .card { background: var(--white); padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; border-left: 6px solid var(--pink-main);}
    .card-title { font-size: 1.2rem; font-weight: 700; color: var(--text-dark); margin-bottom: 5px; }
    .status-pill { position: absolute; top: 20px; right: 20px; font-size: 0.75rem; font-weight: bold; padding: 4px 10px; border-radius: 12px; }
    .status-Pending { background: #fef08a; color: #854d0e; }
    .status-Active { background: var(--pink-light); color: var(--pink-hover); }
    .status-Paid { background: #d1fae5; color: #065f46; }
    .status-Overdue { background: #fee2e2; color: #991b1b; border-left-color: #ef4444; }
    
    .card-details { font-size: 0.9rem; color: var(--text-soft); margin-bottom: 15px; }
    .card-amounts { display: flex; justify-content: space-between; align-items: baseline; border-top: 1px dashed #fbcfe8; padding-top: 10px;}
    .amt-main { font-size: 1.5rem; font-weight: 700; color: var(--pink-main); }

    /* Modals */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
    .modal-content { background: var(--white); padding: 30px; border-radius: 24px; width: 100%; max-width: 400px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .modal-header h2 { color: var(--pink-main); }
    .close-btn { background: none; color: var(--text-soft); font-size: 1.5rem; padding: 0; }
    
    #loader { display: none; position: fixed; top:20px; right:20px; background: white; padding: 10px 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 9999; font-weight: 600; color: var(--pink-main);}
  </style>
</head>
<body>

  <div class="floating-panda">üêº</div>
  <div id="loader">üå∏ Loading...</div>

  <div id="login-overlay">
    <div class="box login-box">
      <h2 style="color: var(--pink-main);">üêº Welcome</h2>
      <input type="password" id="login-pwd" placeholder="Enter password">
      <button onclick="attemptLogin()" style="width: 100%;">Enter Bank</button>
      <p id="login-error" style="color: red; margin-top: 10px; display: none;"></p>
    </div>
  </div>

  <div id="app-container">
    <div class="header">
      <h1>üêº Panda Bank</h1>
      <button class="btn-secondary" style="padding: 6px 12px;" onclick="location.reload()">Log Out</button>
    </div>

    <div class="box totals-board">
      <p style="font-weight: 600; color: var(--text-soft);">Outstanding Balance</p>
      <h2 id="total-amount">0 kr</h2>
    </div>

    <div class="action-buttons">
      <button id="btn-new" onclick="openModal('loanModal')">Request Money</button>
      <button class="btn-secondary" onclick="openPaymentModal()">üí∏ Pay Back (General)</button>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="tab-active" onclick="setTab('Active')">Active Debts</button>
      <button class="tab-btn" id="tab-paid" onclick="setTab('Paid')">Paid stubs</button>
      <button class="tab-btn" id="tab-all" onclick="setTab('All')">Show all</button>
    </div>

    <div class="receipts-grid" id="receipts-container"></div>
  </div>

  <div id="loanModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="loan-modal-title">New Entry</h2>
        <button class="close-btn" onclick="closeModal('loanModal')">&times;</button>
      </div>
      
      <form id="loanForm" onsubmit="submitLoan(event)">
        
        <div id="toggle-wrapper" style="display: none;">
          <div class="toggle-container">
            <div class="toggle-btn active" id="tg-receipt" onclick="switchToggle('Receipt')">Receipt</div>
            <div class="toggle-btn" id="tg-request" onclick="switchToggle('Request')">Request</div>
          </div>
        </div>

        <label>What for?</label>
        <input type="text" id="l-title" placeholder="e.g. School loan" required>
        
        <div class="sentence-input" id="amt-sentence">
          <span>I need at least</span>
          <input type="number" id="l-amount-min" required>
          <span>kr, but if possible</span>
          <input type="number" id="l-amount-ideal">
          <span>kr.</span>
        </div>

        <div id="amt-exact" style="display: none;">
          <label>Exact Amount (kr)</label>
          <input type="number" id="l-amount-exact">
        </div>
        
        <label>Due Date? (Optional)</label>
        <input type="date" id="l-duedate">
        
        <label>Source</label>
        <select id="l-source" required>
          <option value="Vipps">Vipps</option>
          <option value="Bank Transfer">Bank Transfer</option>
        </select>
        
        <button type="submit" style="width: 100%; margin-top: 10px;">Submit</button>
      </form>
    </div>
  </div>

  <div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="pay-title">üí∏ Pay Back</h2>
        <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
      </div>
      
      <p id="pay-desc" style="font-size: 0.9rem; color: var(--text-soft); margin-bottom: 15px;">
        Money paid will cover the oldest debts first.
      </p>

      <form id="paymentForm" onsubmit="submitPayment(event)">
        <input type="hidden" id="p-specific-id">
        
        <label>Amount Paid (kr)</label>
        <input type="number" id="p-amount" required>
        
        <label>Source</label>
        <select id="p-source" required>
          <option value="Vipps">Vipps</option>
          <option value="Bank Transfer">Bank Transfer</option>
        </select>

        <button type="submit" style="width: 100%; margin-top: 10px;">Register Payment</button>
      </form>
    </div>
  </div>

  <div id="approveModal" class="modal-overlay">
    <div class="modal-content" style="text-align: center;">
      <h2>üå∏ Approve Request</h2>
      <p id="app-desc" style="margin: 15px 0; color: var(--text-dark);"></p>
      
      <label style="text-align: left;">Final Amount to Send (kr):</label>
      <input type="number" id="app-final-amount" required>
      
      <p style="font-size: 0.8rem; color: var(--text-soft); margin-bottom: 15px;">
        (Approving this will send a calendar invite!)
      </p>

      <input type="hidden" id="app-id">
      
      <div style="display: flex; gap: 10px;">
        <button class="btn-reject" style="flex: 1;" onclick="processApproval(false)">Reject</button>
        <button style="flex: 1;" onclick="processApproval(true)">Approve ‚úÖ</button>
      </div>
    </div>
  </div>

  <script>
    // ‚ö†Ô∏è REPLACE THIS URL ‚ö†Ô∏è
    const scriptURL = 'YOUR_GOOGLE_WEB_APP_URL_HERE';
    
    let currentRole = ''; 
    let allTransactions = [];
    let currentFilter = 'Active'; // Active, Paid, All
    let currentEntryType = 'Request'; // State for toggle

    // Add CSS Petals
    for(let i=0; i<8; i++) {
      let petal = document.createElement('div');
      petal.className = 'petal'; petal.innerHTML = 'üå∏';
      petal.style.left = Math.random() * 100 + 'vw';
      petal.style.animationDuration = (Math.random() * 3 + 4) + 's';
      petal.style.animationDelay = Math.random() * 5 + 's';
      document.body.appendChild(petal);
    }

    async function apiCall(payload) {
      document.getElementById('loader').style.display = 'block';
      try {
        const response = await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });
        const data = await response.json();
        document.getElementById('loader').style.display = 'none';
        return data;
      } catch (error) {
        document.getElementById('loader').style.display = 'none';
        return { success: false };
      }
    }

    async function attemptLogin() {
      const pwd = document.getElementById('login-pwd').value;
      if (!pwd) return;
      const res = await apiCall({ action: 'login', password: pwd });
      
      if (res.success) {
        currentRole = res.role;
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        
        if (currentRole === 'panda') {
          document.getElementById('btn-new').textContent = 'Log New Entry';
          document.getElementById('toggle-wrapper').style.display = 'block';
          switchToggle('Receipt'); // Default for Panda
        } else {
          switchToggle('Request'); // Forced for Shark
        }
        fetchDashboardData();
      } else {
        document.getElementById('login-error').textContent = res.message;
        document.getElementById('login-error').style.display = 'block';
      }
    }

    function switchToggle(type) {
      currentEntryType = type;
      if (type === 'Receipt') {
        document.getElementById('tg-receipt').classList.add('active');
        document.getElementById('tg-request').classList.remove('active');
        document.getElementById('amt-sentence').style.display = 'none';
        document.getElementById('amt-exact').style.display = 'block';
        document.getElementById('l-amount-exact').required = true;
        document.getElementById('l-amount-min').required = false;
      } else {
        document.getElementById('tg-request').classList.add('active');
        document.getElementById('tg-receipt').classList.remove('active');
        document.getElementById('amt-sentence').style.display = 'flex';
        document.getElementById('amt-exact').style.display = 'none';
        document.getElementById('l-amount-exact').required = false;
        document.getElementById('l-amount-min').required = true;
      }
    }

    async function fetchDashboardData() {
      const res = await apiCall({ action: 'get_data' });
      if (res.success) {
        allTransactions = res.data;
        updateTotals();
        renderReceipts();
      }
    }

    function updateTotals() {
      let total = 0;
      allTransactions.forEach(tx => {
        if (tx['Status'] === 'Active' || tx['Status'] === 'Overdue') {
          total += parseFloat(tx['Remaining Amount']) || 0;
        }
      });
      // Allow negative formatting for surplus
      document.getElementById('total-amount').textContent = total.toLocaleString() + ' kr';
    }

    function setTab(tabName) {
      currentFilter = tabName;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      
      if(tabName === 'Active') document.getElementById('tab-active').classList.add('active');
      if(tabName === 'Paid') document.getElementById('tab-paid').classList.add('active');
      if(tabName === 'All') document.getElementById('tab-all').classList.add('active');
      
      renderReceipts();
    }

    function renderReceipts() {
      const container = document.getElementById('receipts-container');
      container.innerHTML = '';
      
      let filtered = allTransactions.filter(t => t['Entry Type'] !== 'Repayment'); // Hide pure repayment logs from cards
      
      if (currentFilter === 'Active') {
        // Active tab shows Pending, Active, Overdue
        filtered = filtered.filter(t => ['Active', 'Overdue', 'Pending'].includes(t['Status']));
      } else if (currentFilter === 'Paid') {
        filtered = filtered.filter(t => t['Status'] === 'Paid');
      }

      if (filtered.length === 0) {
        container.innerHTML = `<p style="text-align:center; color:var(--text-soft);">No items here! üå∏</p>`;
        return;
      }

      filtered.forEach(tx => {
        const card = document.createElement('div');
        let statusClass = `status-${tx['Status']}`;
        card.className = `card`;
        if (tx['Status'] === 'Overdue') card.style.borderLeftColor = '#ef4444';
        if (tx['Status'] === 'Paid') card.style.borderLeftColor = '#10b981';

        const d = new Date(tx['Date']);
        const originalAmt = parseFloat(tx['Original Amount']);
        const remainingAmt = parseFloat(tx['Remaining Amount']);
        
        let dueHTML = tx['Due Date'] ? `<p><strong>Due:</strong> ${new Date(tx['Due Date']).toLocaleDateString()}</p>` : '';
        
        let actionHTML = '';
        if (tx['Status'] === 'Pending' && currentRole === 'panda') {
          // Pass the min/ideal string if it exists in the original amount field so Panda sees it
          let displayAmt = tx['Original Amount'];
          actionHTML = `<button style="width:100%; margin-top:10px;" onclick="openApproveModal('${tx['ID']}', '${tx['Title / Purpose']}', '${displayAmt}')">Review Request</button>`;
        } else if ((tx['Status'] === 'Active' || tx['Status'] === 'Overdue') && currentRole === 'shark') {
          actionHTML = `<button class="btn-secondary" style="width:100%; margin-top:10px;" onclick="openPaymentModal('${tx['ID']}', ${remainingAmt})">üí∏ Pay This Specific Stub</button>`;
        }

        card.innerHTML = `
          <div class="status-pill ${statusClass}">${tx['Status']}</div>
          <div class="card-title">${tx['Title / Purpose']}</div>
          <div class="card-details">
            <p>${d.toLocaleDateString()}</p>
            ${dueHTML}
          </div>
          <div class="card-amounts">
            <div>
              <span style="font-size:0.8rem; color:var(--text-soft);">Original: ${originalAmt} kr</span>
            </div>
            <div class="amt-main">${tx['Status'] === 'Paid' ? 'Paid' : remainingAmt + ' kr'}</div>
          </div>
          ${actionHTML}
        `;
        container.appendChild(card);
      });
    }

    async function submitLoan(e) {
      e.preventDefault();
      let finalAmount = 0;
      
      if (currentEntryType === 'Request') {
        const min = document.getElementById('l-amount-min').value;
        const ideal = document.getElementById('l-amount-ideal').value;
        finalAmount = ideal ? `${min}-${ideal}` : min; // Send as a string for Panda to read
      } else {
        finalAmount = document.getElementById('l-amount-exact').value;
      }

      const finalRole = (currentRole === 'panda' && currentEntryType === 'Request') ? 'shark' : currentRole;

      const res = await apiCall({
        action: 'submit_request', role: finalRole,
        title: document.getElementById('l-title').value,
        amount: finalAmount, dueDate: document.getElementById('l-duedate').value,
        source: document.getElementById('l-source').value
      });

      if(res.success) {
        closeModal('loanModal');
        document.getElementById('loanForm').reset();
        fetchDashboardData();
      }
    }

    function openPaymentModal(specificId = null, amountOwed = null) {
      document.getElementById('p-specific-id').value = specificId || '';
      
      if (specificId) {
        document.getElementById('pay-title').textContent = "üí∏ Pay Specific Stub";
        document.getElementById('pay-desc').textContent = "This payment will ONLY apply to this stub.";
        document.getElementById('p-amount').value = amountOwed;
      } else {
        document.getElementById('pay-title').textContent = "üí∏ Pay Back (General)";
        document.getElementById('pay-desc').textContent = "Money paid will cover the oldest debts first via waterfall logic.";
        document.getElementById('p-amount').value = '';
      }
      openModal('paymentModal');
    }

    async function submitPayment(e) {
      e.preventDefault();
      const res = await apiCall({
        action: 'log_payment',
        amount: document.getElementById('p-amount').value,
        source: document.getElementById('p-source').value,
        specificId: document.getElementById('p-specific-id').value
      });

      if(res.success) {
        closeModal('paymentModal');
        document.getElementById('paymentForm').reset();
        fetchDashboardData();
      }
    }

    function openApproveModal(id, title, reqAmountStr) {
      document.getElementById('app-id').value = id;
      document.getElementById('app-desc').textContent = `The Shark requested: ${reqAmountStr} kr for "${title}".`;
      // If it's a range like "100-500", try to pre-fill the input with the lower number just for ease
      let suggestedAmt = reqAmountStr.toString().split('-')[0];
      document.getElementById('app-final-amount').value = suggestedAmt;
      openModal('approveModal');
    }

    async function processApproval(isApproved) {
      const id = document.getElementById('app-id').value;
      const finalAmt = document.getElementById('app-final-amount').value;
      
      let res;
      if (isApproved) {
        if (!finalAmt) return alert("Please enter the final amount.");
        res = await apiCall({ action: 'approve_loan', id: id, finalAmount: finalAmt });
      } else {
        if(confirm("Are you sure you want to REJECT this request?")) {
           res = await apiCall({ action: 'reject_loan', id: id });
        } else return;
      }

      if(res.success) {
        closeModal('approveModal');
        fetchDashboardData();
      }
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  </script>
</body>
</html>
